name: ci

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  build-and-test:
    uses: ./.github/workflows/ziggy-shared-ci.yml
    with:
      verify_script: |
        if grep -qE '\.path = "\.\./Ziggy' build.zig.zon; then
          echo "Local path Ziggy dependencies are not allowed in CI"
          exit 1
        fi
        grep -q 'ziggy_spider_protocol' build.zig.zon
        grep -q 'ziggy_memory_store' build.zig.zon
        grep -q 'ziggy_tool_runtime' build.zig.zon
        grep -q 'ziggy_runtime_hooks' build.zig.zon
        grep -q 'ziggy_run_orchestrator' build.zig.zon
        grep -q '\.hash =' build.zig.zon
      extra_commands: |
        SKIP_BUILD=1 bash test-env/test-distributed-workspace-matrix.sh

  windows-fs-tests:
    name: windows-fs-tests
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.1

      - name: Zig version
        run: zig version

      - name: Run Windows FS adapter tests
        run: zig test src/fs_windows_source_adapter.zig

      - name: Run router and node ops tests
        run: |
          zig test src/fs_router.zig
          zig test src/fs_node_ops.zig --test-filter "windows source"
